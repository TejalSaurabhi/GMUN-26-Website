import React, { useState, useEffect } from "react";
import { motion, AnimatePresence } from "framer-motion"; // Added AnimatePresence
import StarsBackground from "./Home/StarsBackground";

const Preloader = () => {
  const [phase, setPhase] = useState(0);
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
  const [isVisible, setIsVisible] = useState(true); // Track visibility for exit

  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth < 768);
    window.addEventListener("resize", handleResize);

    // Animation Sequence
    setTimeout(() => setPhase(1), 500);  // Scale up
    setTimeout(() => setPhase(2), 2500); // Slide and start writing

    // --- TRIGGER EXIT ---
    // Timing: 2500ms (start) + 1000ms (text delay) + 8000ms (writing) + 1500ms ( removed buffer)
    const exitTimer = setTimeout(() => setIsVisible(false), 7000); //7000 

    return () => {
      window.removeEventListener("resize", handleResize);
      clearTimeout(exitTimer);
    };
  }, []);

  const logoVariants = {
    initial: { scale: 0, x: 0, opacity: 0 },
    scaled: { 
      scale: 1, 
      x: 0, 
      opacity: 1,
      transition: { duration: 1.2, ease: [0.34, 1.56, 0.64, 1] },
      filter: "drop-shadow(0px 0px 5px rgba(255, 235, 51, 0.3))"
    },
    moved: { 
      scale: 1,
      x: isMobile ? 0 : -300,    
      y: isMobile ? -100 : 0,    
      opacity: 1,
      transition: { 
        duration: 0.8,
        ease: "easeInOut",
        filter: { delay: 1, duration: 1 } 
      },
      filter: "drop-shadow(0px 0px 20px #b05a00)"
    }
  };

  const textPaths = ["m 40.551588,73.335304 v 4.191 q -0.5842,0.762 -1.5748,1.524 -0.9906,0.762 -2.4384,1.27 -1.4224,0.4826 -3.3528,0.4826 -2.6924,-0.0254 -4.7498,-1.1684 -2.0574,-1.1684 -3.2258,-3.2258 -1.143,-2.0828 -1.143,-4.8514 0,-2.7686 1.143,-4.8514 1.1684,-2.0828 3.2258,-3.2258 2.0574,-1.1684 4.7498,-1.1684 1.397,0 2.5146,0.2286 1.1176,0.2286 2.0066,0.635 0.9144,0.381 1.651,0.8636 l 0.508,3.5814 h -0.2286 q -0.381,-1.4732 -1.27,-2.4638 -0.8636,-1.016 -2.1844,-1.5494 -1.3208,-0.5334 -2.9972,-0.5334 -2.1336,0 -3.7592,1.0668 -1.6256,1.0668 -2.54,2.9718 -0.9144,1.905 -0.9144,4.445 0,2.54 0.9144,4.445 0.9144,1.905 2.54,2.9718 1.6256,1.0414 3.7592,1.0668 1.1176,0 2.1336,-0.254 1.0414,-0.2794 1.9558,-0.762 0.9144,-0.508 1.6256,-1.1938 l 0.0254,-4.4958 q 0,-1.143 -1.2954,-1.143 h -0.4064 v -0.254 h 4.9784 v 0.254 h -0.381 q -1.3208,0 -1.27,1.143 z m 21.082008,-11.0236 0.2032,1.7018 -6.375399,14.1986 q 0,0 -0.2032,0.4318 -0.1778,0.4318 -0.381,1.0414 -0.2032,0.5842 -0.2794,1.1176 h -0.254 l -0.3556,-1.6002 z m -15.620999,16.2814 v 1.8542 h -2.8194 v -0.254 q 0.0254,0 0.2032,0 0.2032,0 0.2032,0 0.6858,0 1.2192,-0.4064 0.5334,-0.4318 0.635,-1.1938 z m 0.7366,0.4064 q 0,0.0254 0,0.0508 0,0.0254 0,0.0762 0,0.4064 0.2794,0.762 0.3048,0.3302 0.7112,0.3302 h 0.381 v 0.2286 h -1.5494 v -1.4478 z m 0.6096,-16.6878 h 0.254 l 0.508,1.4986 -1.4986,16.637 h -1.3716 z m 0.254,0 7.3152,15.8242 -0.5842,2.667 -7.2136,-15.6464 z m 14.249399,0 2.1844,18.1356 h -1.9812 l -1.397,-15.3924 0.9652,-2.7432 z m 1.4224,16.2814 h 0.5334 q 0.127,0.762 0.6604,1.1938 0.5334,0.4064 1.1938,0.4064 0,0 0.2032,0 0.2032,0 0.2032,0 v 0.254 h -2.794 z m -1.3462,0.4064 h 0.1778 v 1.4478 h -1.5494 v -0.2286 h 0.381 q 0.4318,0 0.7112,-0.3302 0.2794,-0.3556 0.2794,-0.762 0,-0.0508 0,-0.0762 0,-0.0254 0,-0.0508 z m 8.686784,-16.3322 v 11.176 q 0,1.8288 0.6604,3.2258 0.6858,1.397 1.905,2.1844 1.2192,0.762 2.8194,0.762 1.7018,0 2.9718,-0.7366 1.27,-0.7366 1.9812,-2.032 0.7112,-1.3208 0.7112,-3.0734 v -11.5062 h 1.1938 v 11.5062 q 0,1.9812 -0.8636,3.4798 -0.8382,1.4732 -2.3876,2.3114 -1.5494,0.8382 -3.6068,0.8382 -2.1082,0 -3.7084,-0.8128 -1.5748,-0.8382 -2.4638,-2.3114 -0.8636,-1.4986 -0.8636,-3.4798 v -11.5316 z m -1.5748,0 v 1.524 h -0.0762 q 0,-0.5588 -0.4064,-0.9144 -0.381,-0.3556 -0.9398,-0.3556 0,0 -0.2032,0 -0.2032,0 -0.2032,0 v -0.254 z m 3.3274,0 v 0.254 q 0,0 -0.2032,0 -0.2032,0 -0.2032,0 -0.5588,0 -0.9652,0.3556 -0.381,0.3556 -0.381,0.9144 h -0.0508 v -1.524 z m 9.3726,0 v 1.524 h -0.0762 q 0,-0.5588 -0.4064,-0.9144 -0.381,-0.3556 -0.9398,-0.3556 0,0 -0.2032,0 -0.2032,0 -0.2032,0 v -0.254 z m 2.8702,0 v 0.254 q 0,0 -0.2032,0 -0.2032,0 -0.2032,0 -0.5588,0 -0.9652,0.3556 -0.381,0.3556 -0.381,0.9144 h -0.0508 v -1.524 z m 4.14018,-0.381 14.7574,15.748 0.2286,2.7686 -14.7574,-15.7226 z m 0.0508,16.3576 v 1.8034 h -2.1082 v -0.254 q 0,0 0.2286,0 0.2286,0 0.254,0 0.635,0 1.0922,-0.4572 0.4572,-0.4572 0.4572,-1.0922 z m 1.0922,0 q 0,0.635 0.4572,1.0922 0.4572,0.4572 1.0922,0.4572 0.0254,0 0.254,0 0.2286,0 0.2286,0 v 0.254 h -2.1082 v -1.8034 z m -1.143,-16.3576 1.1176,1.4224 0.0254,16.7386 h -1.1684 v -14.986 q 0,-1.2954 -0.127,-2.2352 -0.1016,-0.9398 -0.1016,-0.9398 z m 14.986,0.381 v 14.8844 q 0,0.8128 0.0508,1.5748 0.0508,0.7366 0.1016,1.2192 0.0762,0.4572 0.0762,0.4572 h -0.2286 l -1.143,-1.3462 v -16.7894 z m 2.032,0 v 0.254 q 0,0 -0.2286,0 -0.2286,0 -0.2286,0 -0.635,0 -1.0922,0.4572 -0.4572,0.4318 -0.4826,1.0922 h -0.0762 v -1.8034 z m -5.2324,0 h 2.1082 v 1.8034 h -0.0508 q -0.0254,-0.6604 -0.4826,-1.0922 -0.4318,-0.4572 -1.0922,-0.4572 0,0 -0.2286,0 -0.2286,0 -0.254,0 z m 15.06219,4.1656 -0.4572,-2.8702 q 0.4826,-0.4826 1.2446,-0.8382 0.762,-0.381 1.6256,-0.5842 0.8636,-0.2286 1.6764,-0.2286 1.6764,0 2.921,0.6096 1.27,0.6096 1.9558,1.7272 0.6858,1.1176 0.6858,2.6924 0,1.2954 -0.5842,2.6416 -0.5588,1.3208 -1.4732,2.6162 -0.9144,1.27 -1.9812,2.4638 -1.0668,1.1684 -2.0828,2.1844 -1.016,0.9906 -1.778,1.778 h 5.842 q 0.762,0 1.2446,-0.2032 0.508,-0.2032 0.889,-0.6858 0.4064,-0.4826 0.8382,-1.27 h 0.254 l -1.1938,3.5814 h -10.4394 v -0.254 q 0.889,-0.8128 2.0066,-1.9812 1.143,-1.1938 2.286,-2.5654 1.143,-1.3716 2.1082,-2.8194 0.9652,-1.4478 1.5494,-2.8194 0.6096,-1.397 0.6096,-2.5654 0,-2.0574 -0.9906,-3.2258 -0.9652,-1.1938 -2.667,-1.143 -1.778,0.0254 -2.8194,0.9906 -1.0414,0.9652 -1.016,2.7686 z m 19.27859,-4.5212 q 1.8542,0 3.175,1.1176 1.3462,1.1176 2.0574,3.2004 0.7366,2.0574 0.7366,4.9276 0,2.8702 -0.7366,4.953 -0.7112,2.0574 -2.0574,3.175 -1.3208,1.1176 -3.175,1.1176 -1.8542,0 -3.2004,-1.1176 -1.3208,-1.1176 -2.0574,-3.175 -0.7112,-2.0828 -0.7112,-4.953 0,-2.8702 0.7112,-4.9276 0.7366,-2.0828 2.0574,-3.2004 1.3462,-1.1176 3.2004,-1.1176 z m 0,0.762 q -1.9304,0 -3.0734,2.286 -1.1176,2.2606 -1.1176,6.1976 0,3.937 1.1176,6.223 1.143,2.2606 3.0734,2.2606 1.9558,0 3.0734,-2.2606 1.1176,-2.286 1.1176,-6.223 0,-3.937 -1.1176,-6.1976 -1.1176,-2.286 -3.0734,-2.286 z m 9.27102,3.7592 -0.4572,-2.8702 q 0.4826,-0.4826 1.2446,-0.8382 0.762,-0.381 1.6256,-0.5842 0.8636,-0.2286 1.6764,-0.2286 1.6764,0 2.921,0.6096 1.27,0.6096 1.9558,1.7272 0.6858,1.1176 0.6858,2.6924 0,1.2954 -0.5842,2.6416 -0.5588,1.3208 -1.4732,2.6162 -0.9144,1.27 -1.9812,2.4638 -1.0668,1.1684 -2.0828,2.1844 -1.016,0.9906 -1.778,1.778 h 5.842 q 0.762,0 1.2446,-0.2032 0.508,-0.2032 0.889,-0.6858 0.4064,-0.4826 0.8382,-1.27 h 0.254 l -1.1938,3.5814 h -10.4394 v -0.254 q 0.889,-0.8128 2.0066,-1.9812 1.143,-1.1938 2.286,-2.5654 1.143,-1.3716 2.1082,-2.8194 0.9652,-1.4478 1.5494,-2.8194 0.6096,-1.397 0.6096,-2.5654 0,-2.0574 -0.9906,-3.2258 -0.9652,-1.1938 -2.667,-1.143 -1.778,0.0254 -2.8194,0.9906 -1.0414,0.9652 -1.016,2.7686 z m 21.8948,-5.0292 0.1016,0.1778 q -1.8034,0.5842 -3.0988,1.7272 -1.27,1.1176 -2.0828,2.667 -0.7874,1.524 -1.1684,3.3528 -0.381,1.8288 -0.381,3.81 0,1.905 0.4318,3.3782 0.4572,1.4732 1.3208,2.3114 0.889,0.8382 2.1844,0.8382 1.2192,0 1.9558,-0.6858 0.762,-0.6858 1.1176,-1.7526 0.381,-1.0922 0.3556,-2.3114 -0.0254,-1.27 -0.4318,-2.2098 -0.381,-0.9398 -1.143,-1.4478 -0.762,-0.5334 -1.8542,-0.5334 -0.7874,0 -1.5494,0.3302 -0.7366,0.3302 -1.2446,0.9906 l -0.1524,-0.2286 q 0.6604,-0.7874 1.4986,-1.27 0.8382,-0.508 1.7272,-0.6604 0.9144,-0.1778 1.7526,0.0254 0.8636,0.1778 1.5748,0.7366 0.7112,0.5588 1.1684,1.5494 0.4572,0.9652 0.5588,2.3622 0.1016,1.4732 -0.5334,2.8194 -0.6096,1.3208 -1.8542,2.1844 -1.2192,0.8382 -2.9464,0.8636 -1.7018,0.0254 -3.048,-0.8382 -1.3208,-0.8636 -2.0828,-2.4892 -0.7366,-1.651 -0.7112,-3.9624 0.0254,-1.9812 0.5334,-3.937 0.5334,-1.9812 1.5748,-3.6322 1.0414,-1.6764 2.6416,-2.794 1.6002,-1.1176 3.7846,-1.3716 z"]; // Your SVG path data

  return (
    <AnimatePresence>
      {isVisible && (
        <motion.div 
          style={styles.container}
          // --- EXIT ANIMATION RULES ---
          initial={{ opacity: 1 }}
          exit={{ 
            opacity: 0, 
            filter: "blur(20px)", // Cinematic blur on exit
            scale: 1.05,          // Slight zoom out effect
            transition: { duration: 1.5, ease: "easeInOut" } 
          }}
        >
          <StarsBackground />
          
          <div style={{
            ...styles.contentWrapper,
            flexDirection: isMobile ? "column" : "row"
          }}>
            
            <motion.div
              initial="initial"
              animate={phase === 0 ? "initial" : phase === 1 ? "scaled" : "moved"}
              variants={logoVariants}
            >
              <motion.img
                src="/GMUN-logo-date.png" 
                alt="GMUN Logo"
                style={{
                  width: isMobile ? "200px" : "280px",
                  height: "auto",
                  display: "block"
                }}
              />
            </motion.div>

            {phase === 2 && (
                <motion.svg
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  viewBox="0 0 146.66801 19.049952" 
                  style={{ 
                      position: "absolute", 
                      left: isMobile ? "0" : "35%", 
                      marginTop: isMobile ? "-45%" : "-32%",
                      width: isMobile ? "80%" : "35%", 
                      height: "auto",
                      overflow: "visible"
                  }}
                >
                  {textPaths.map((d, index) => (
                    <motion.path
                      key={index}
                      d={d}
                      stroke="#9B7C60"
                      strokeWidth=".5"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      initial={{ pathLength: 0, opacity: 0, fill: "rgba(255, 255, 255, 0)", filter: "drop-shadow(0px 0px 0px rgba(255, 235, 51, 0.3))" }}
                      animate={{ pathLength: 1, opacity: 1, fill: "#9B7C60", filter: "drop-shadow(0px 0px 5px rgba(255, 235, 51, 0.3))"}}
                      transition={{
                        fill: { delay: 3, duration: 1}, 
                        filter: {delay: 3, duration: 1},
                        pathLength: { delay: 1, duration: 8, ease: "linear" }, // Match your 8s duration
                        opacity: { duration: 0.5, delay: 1 },
                      }}
                    />
                  ))}
                </motion.svg>
            )}
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

const styles = {
  container: {
    position: "fixed", top: 0, left: 0, width: "100vw", height: "100vh",
    background: "radial-gradient(circle at bottom, #043132ff, #000)",
    display: "flex", justifyContent: "center", alignItems: "center", zIndex: 9999,
  },
  contentWrapper: {
    display: "flex", alignItems: "center", justifyContent: "center", position: "relative", width: "100%"
  }
};

export default Preloader;